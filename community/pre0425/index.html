<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Upload CSV â€” Legacy Member Import (A,B or name,email)</title>
  <style>
    body{font-family:system-ui;max-width:800px;margin:20px auto;padding:10px}
    input[type=file], input[type=text]{width:100%;padding:8px;margin:6px 0;box-sizing:border-box}
    button{padding:8px 12px;margin-right:8px}
    pre{background:#f6f7fb;padding:10px;border-radius:6px;overflow:auto}
    table{border-collapse:collapse;width:100%}
    td,th{border:1px solid #ddd;padding:6px}
  </style>
</head>
<body>
  <h2>Legacy Member CSV Upload</h2>
  <p>Header row must contain <b>name,email</b> or shorthand <b>A,B</b> (A=name, B=email). Case-insensitive.</p>

  <label>Worker URL</label>
  <input id="url" type="text" value="https://legacy-member-import.ksn-nvl.workers.dev/l">

  <label>CSV file (with header row)</label>
  <input id="file" type="file" accept=".csv,text/csv">

  <div style="margin-top:8px">
    <button id="preview">Preview</button>
    <button id="upload" disabled>Upload CSV</button>
    <button id="clear">Clear</button>
  </div>

  <h3>Preview (first 8 rows)</h3>
  <div id="previewArea"><div style="color:#666">No file loaded.</div></div>

  <h3>Server response</h3>
  <pre id="out">No upload yet.</pre>

<script>
  const fileEl = document.getElementById('file');
  const previewBtn = document.getElementById('preview');
  const uploadBtn = document.getElementById('upload');
  const clearBtn = document.getElementById('clear');
  const previewArea = document.getElementById('previewArea');
  const out = document.getElementById('out');
  const urlEl = document.getElementById('url');
  let lastCsv = '';

  function parsePreviewCSV(text, maxRows=8) {
    // simple CSV preview parser that handles quoted fields
    const rows = [];
    let cur = '', inQuotes = false, row = [];
    for (let i=0;i<text.length;i++){
      const ch = text[i];
      const nch = text[i+1];
      if (ch === '"') {
        if (inQuotes && nch === '"') { cur += '"'; i++; continue; }
        inQuotes = !inQuotes; continue;
      }
      if (ch === ',' && !inQuotes) { row.push(cur); cur=''; continue; }
      if ((ch === '\n' || ch === '\r') && !inQuotes) {
        row.push(cur); cur='';
        rows.push(row);
        row = [];
        if (ch === '\r' && nch === '\n') i++;
        if (rows.length >= maxRows) break;
        continue;
      }
      cur += ch;
    }
    if (row.length>0 || cur !== '') {
      row.push(cur);
      rows.push(row);
    }
    return rows;
  }

  previewBtn.onclick = async () => {
    const f = fileEl.files[0];
    if (!f) { alert('Select a CSV file'); return; }
    const txt = await f.text();
    lastCsv = txt;
    const rows = parsePreviewCSV(txt, 8);
    if (rows.length === 0) {
      previewArea.innerHTML = '<div style="color:#a00">No rows found in file</div>';
      uploadBtn.disabled = true;
      return;
    }
    // render table
    let html = '<table><thead><tr>';
    const header = rows[0] || [];
    for (let i=0;i<header.length;i++) html += `<th>${escapeHtml(header[i])}</th>`;
    html += '</tr></thead><tbody>';
    for (let r=1;r<rows.length;r++){
      html += '<tr>';
      for (let c=0;c<header.length;c++){
        html += `<td>${escapeHtml(rows[r][c]||'')}</td>`;
      }
      html += '</tr>';
    }
    html += '</tbody></table>';
    previewArea.innerHTML = html;
    uploadBtn.disabled = false;
    out.textContent = 'Preview OK. Ready to upload.';
  };

  uploadBtn.onclick = async () => {
    if (!lastCsv) { alert('Preview first'); return; }
    const url = urlEl.value.trim();
    if (!url) { alert('Set worker URL'); return; }
    uploadBtn.disabled = true;
    out.textContent = 'Uploading...';

    try {
      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'text/csv' },
        body: lastCsv
      });
      const text = await resp.text();
      try { out.textContent = JSON.stringify(JSON.parse(text), null, 2); }
      catch (e) { out.textContent = text; }
    } catch (err) {
      out.textContent = 'Upload error: ' + err.message;
    } finally {
      uploadBtn.disabled = false;
    }
  };

  clearBtn.onclick = () => {
    fileEl.value = '';
    lastCsv = '';
    previewArea.innerHTML = '<div style="color:#666">No file loaded.</div>';
    out.textContent = 'Cleared';
    uploadBtn.disabled = true;
  };

  function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
</script>
</body>
</html>
