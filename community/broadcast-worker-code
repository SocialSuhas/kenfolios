/**
 * KENFOLIOS + VSTREET TELEGRAM BROADCAST WORKER
 *
 * Full worker file â€” drop into Cloudflare Workers (module).
 * Make sure to set the environment secrets:
 *   - TELEGRAM_BOT_TOKEN
 *   - TELEGRAM_GROUP_ID
 *   - TELEGRAM_WEBHOOK_SECRET
 *
 * Cron triggers to add (UTC cron lines):
 *   30 02 * * *   -> 08:00 IST (morning)
 *   30 06 * * *   -> 12:00 IST (noon)
 *   30 10 * * *   -> 16:00 IST (afternoon)
 *   30 14 * * *   -> 20:00 IST (evening)
 *   30 16 * * *   -> 22:00 IST (Silent Hours)
 */

///////////////////////////////////////////////////////////////
// >>> SILENT HOURS ADDITION
///////////////////////////////////////////////////////////////

const SILENT_HOURS_MESSAGE = `Silent Hours ğŸ¤«
Dear Members,
To maintain clarity and structured communication, posting is paused from 10 PM to 8 AM.
The group will reopen for posting at 8 AM. We appreciate your understanding.`;

///////////////////////////////////////////////////////////////
// === PART 0: MESSAGE POOLS & CONFIG (UNCHANGED)
///////////////////////////////////////////////////////////////

const SPECIAL_FULL_DAY = {
  "01-26": {
    morning: "Dear Members, good morning ğŸ‡®ğŸ‡³ Today we celebrate Republic Day â€” a reminder of discipline, integrity and collective progress. Letâ€™s move through the day with clarity and professionalism. ğŸŒŸ",
    noon: "Dear Members, good afternoon ğŸ‡®ğŸ‡³ On Republic Day, letâ€™s appreciate the systems that enable modern business and the responsibility we hold to strengthen them through ethical work. ğŸ¤",
    afternoon: "Dear Members, good evening ğŸ‡®ğŸ‡³ As we wrap our workday, letâ€™s close one meaningful task and strengthen our progress today. Small actions build strong culture. ğŸŒ¿",
    evening: "Dear Members, good evening ğŸ‡®ğŸ‡³ Let's end Republic Day with gratitude and clarity as we prepare for a new day. Professionalism and respect build strong communities. ğŸŒ™"
  },

  "08-15": {
    morning: "Dear Members, good morning ğŸ‡®ğŸ‡³ Independence Day reminds us to build with purpose and honesty. Letâ€™s use our work to strengthen Indiaâ€™s ecosystem and move forward with clarity. ğŸŒ…",
    noon: "Dear Members, good afternoon ğŸ‡®ğŸ‡³ On this day of freedom, letâ€™s honour self-reliance by supporting one another through ethical collaboration and thoughtful communication. ğŸ¤",
    afternoon: "Dear Members, good evening ğŸ‡®ğŸ‡³ As we close our workday, letâ€™s complete one meaningful task that reflects growth and responsibility. Small wins matter. ğŸŒ¿",
    evening: "Dear Members, good evening ğŸ‡®ğŸ‡³ Ending Independence Day with gratitude and renewed focus helps us build cleaner, stronger business culture. ğŸŒ™"
  },

  "12-31": {
    morning: "Dear Members, good morning ğŸŒ… It's the final day of the year. Letâ€™s reflect on learnings and close the year with clarity. Small improvements today set a better tone for tomorrow. âœ¨",
    noon: "Dear Members, good afternoon ğŸŒ Year-end is a great moment to finish pending tasks and clear space for new beginnings. A tidy mind creates strong outcomes. ğŸ“‚",
    afternoon: "Dear Members, good evening ğŸŒ‡ The final hours of the year are here. If something is unresolved, share it â€” someone may offer a quick perspective. Collaboration builds clarity. ğŸ¤",
    evening: "Dear Members, good evening ğŸŒ™ As we close the year, letâ€™s acknowledge progress and appreciate resilience. Wishing you a peaceful transition into the new year. ğŸŒŸ",
    midnight: "Dear Members, happy new year ğŸ‰ Wishing you clarity, discipline and meaningful progress. Letâ€™s build stronger systems and support each otherâ€™s journey. âœ¨"
  },

  "01-01": {
    morning: "Dear Members, good morning ğŸ‰ A new year begins with intention and clarity. Wishing you a meaningful and disciplined year ahead. Letâ€™s build with purpose. ğŸŒŸ",
    noon: "Dear Members, good afternoon âœ¨ Today is a moment to outline simple, achievable priorities for the year. Consistency builds strong outcomes. ğŸ“˜",
    afternoon: "Dear Members, good evening ğŸŒ‡ As the first workday progresses, complete one important task to set the tone for the year ahead. âœ”ï¸",
    evening: "Dear Members, good evening ğŸŒ™ A peaceful close to Day 1. Reflect, reset and prepare for tomorrow. Growth is built daily. ğŸŒ¿"
  }
};

const SPECIAL_SINGLE_SLOT = {
  "03-31": {
    slot: "noon",
    message: "Dear Members, good afternoon ğŸ“Š Today marks the financial year end â€” a strong moment to wrap pending tasks and prepare a clean slate for tomorrow. Steady clarity builds strong years. âœ¨"
  },

  "04-01": {
    slot: "noon",
    message: "Dear Members, good afternoon ğŸŒ± A new financial year begins today. Letâ€™s step in with disciplined planning, ethical intent and long-term focus. Wishing everyone a strong year ahead. ğŸ“ˆ"
  }
};

const OBSERVANCE_DAYS = {
  "05-01": { slot: "noon", message: "Dear Members, good afternoon ğŸ’¼ On Labour Day, we acknowledge the dignity of disciplined work and the value of collaboration. Letâ€™s keep building a community rooted in clarity and professionalism. ğŸ¤" },
  "06-27": { slot: "noon", message: "Dear Members, good afternoon ğŸ“ˆ Today is MSME Day â€” a reminder that small and mid-sized businesses drive growth. Letâ€™s support each other with knowledge and ethical collaboration. ğŸŒŸ" },
  "06-30": { slot: "noon", message: "Dear Members, good afternoon ğŸŒ Social Media Day reminds us that clarity and context build meaningful connections. Letâ€™s communicate thoughtfully and professionally. âœ¨" },
  "04-28": { slot: "noon", message: "Dear Members, good afternoon ğŸ¦º Workplace Safety Day highlights the importance of safe, organised and healthy environments. Small improvements create long-term productivity. âœ”ï¸" },
  "06-05": { slot: "morning", message: "Dear Members, good morning ğŸŒ± World Environment Day reminds us how daily choices shape a healthier future. Letâ€™s reduce waste and build responsible businesses. ğŸŒ" },
  "06-21": { slot: "morning", message: "Dear Members, good morning ğŸ§˜â€â™‚ï¸ Yoga Day encourages balance in work and life. A few minutes of calm or stretching can improve clarity and energy. Start light today. ğŸŒ" },
  "01-24": { slot: "noon", message: "Dear Members, good afternoon ğŸ“ Education Day reminds us that continuous learning strengthens decisions and growth. Letâ€™s share insights that elevate our community. ğŸŒŸ" },
  "04-07": { slot: "morning", message: "Dear Members, good morning â¤ï¸ World Health Day reminds us that physical and mental well-being fuels strong decisions. Letâ€™s stay mindful today. ğŸŒ¿" },
  "09-29": { slot: "morning", message: "Dear Members, good morning â¤ï¸â€ğŸ©¹ On World Heart Day, letâ€™s be mindful of choices that support long-term health. Healthy decisions strengthen our clarity and work. ğŸŒ¿" },
  "10-10": { slot: "noon", message: "Dear Members, good afternoon ğŸ’š On World Mental Health Day, letâ€™s pause, reflect and maintain balance. Healthy minds build healthy decisions. ğŸŒ±" },
  "11-14": { slot: "noon", message: "Dear Members, good afternoon ğŸŒ¿ On Diabetes Day, letâ€™s stay mindful of habits that support long-term well-being. Balanced living strengthens our clarity and focus. âœ¨" },
  "02-04": { slot: "noon", message: "Dear Members, good afternoon ğŸ—ï¸ World Cancer Day reminds us of compassion, awareness and support. Health and empathy strengthen communities. ğŸŒ¼" },
  "12-03": { slot: "noon", message: "Dear Members, good afternoon â™¿ Disability Day highlights inclusion and thoughtful support. Respectful communication strengthens every professional space. ğŸ¤" },
  "12-01": { slot: "noon", message: "Dear Members, good afternoon ğŸ—ï¸ Today is World AIDS Day â€” a reminder to stay informed, compassionate and responsible. Awareness builds safer societies. ğŸŒ¿" },
  "01-30": { slot: "noon", message: "Dear Members, good afternoon ğŸ•Šï¸ Martyrsâ€™ Day invites quiet reflection. Letâ€™s honour integrity and stay mindful of values that guide ethical work. âœ¨" },
  "05-11": { slot: "noon", message: "Dear Members, good afternoon ğŸ¤– National Technology Day celebrates innovation. Letâ€™s explore ideas that make our work smarter, cleaner and more efficient. âš¡" },
  "02-28": { slot: "noon", message: "Dear Members, good afternoon ğŸ”¬ National Science Day reminds us how curiosity and knowledge shape better solutions. Letâ€™s keep learning. ğŸŒŸ" },
  "04-23": { slot: "noon", message: "Dear Members, good afternoon ğŸ“˜ World Book Day reminds us of the power of reading. One strong idea can transform how we think and work. ğŸŒ±" },
  "11-12": { slot: "noon", message: "Dear Members, good afternoon â­ World Quality Day highlights that clarity, precision and discipline create strong systems. Letâ€™s improve one small thing today. âœ”ï¸" },
  "09-15": { slot: "morning", message: "Dear Members, good morning ğŸ› ï¸ Happy Engineers Day! Today we appreciate those who build and solve. Strong systems come from thoughtful engineering in work and life. ğŸŒŸ" },
  "09-08": { slot: "noon", message: "Dear Members, good afternoon ğŸ“– On International Literacy Day, letâ€™s value learning and clarity. Literacy strengthens decision-making and professional growth. âœ¨" },
  "05-31": { slot: "noon", message: "Dear Members, good afternoon ğŸŒ¿ World No Tobacco Day reminds us to prioritise long-term health. Healthy habits support strong thinking and sustainable performance. ğŸŒ±" },
  "03-15": { slot: "noon", message: "Dear Members, good afternoon ğŸ›¡ï¸ World Consumer Rights Day highlights transparency and fairness. Letâ€™s maintain honest, ethical practices in all interactions. ğŸ¤" },
  "02-20": { slot: "noon", message: "Dear Members, good afternoon ğŸŒ World Social Justice Day reminds us that fairness and balance strengthen communities and workplaces. Letâ€™s act responsibly. âœ¨" },
  "03-08": { slot: "noon", message: "Dear Members, good afternoon ğŸŒ¼ Todayâ€™s observance reminds us to build inclusive, respectful spaces where clarity, ethics and professionalism guide our actions." },
  "06-14": { slot: "morning", message: "Dear Members, good morning â¤ï¸ Today is World Blood Donor Day â€” a reminder of generosity and community strength. Letâ€™s appreciate those who support life and health. ğŸŒ¿" },
  "12-05": { slot: "noon", message: "Dear Members, good afternoon ğŸŒ± International Volunteer Day celebrates selfless service. Small acts of support strengthen community trust. ğŸ¤" },
  "06-08": { slot: "morning", message: "Dear Members, good morning ğŸŒŠ World Oceans Day reminds us to protect natural systems that support life and business. Mindful choices matter. ğŸŒ" },
  "03-21": { slot: "morning", message: "Dear Members, good morning ğŸŒ¿ International Day of Forests highlights how natural resources support our future. Letâ€™s value sustainability in decisions. ğŸŒ±" }
};

const MONDAY_MORNING = [
  "Dear Members, good morning ğŸŒ… Itâ€™s a fresh week â€” a clean slate to build clarity, discipline and steady momentum. Start meaningfully. âœ¨",
  "Dear Members, good morning ğŸŒ A new week begins â€” reset lightly, organise your thoughts and take one calm step toward progress. Consistency builds strength. âœ¨",
  "Dear Members, good morning ğŸŒ… Mondays set the tone. Begin with clarity, refine priorities and move with steady focus. One strong start shapes the week. âœ”ï¸",
  "Dear Members, good morning ğŸŒ¼ Letâ€™s enter the week with balance and structure. A simple plan today creates smoother days ahead. Build calmly and intentionally. ğŸŒ¿"
];

const MONDAY_NOON = [
  "Dear Members, good afternoon â˜€ï¸ Letâ€™s gear up for the week. A quick plan and clean priorities build strong direction. âœ”ï¸",
  "Dear Members, good afternoon ğŸŒ¿ Midday check-ins help shape the week ahead. Review lightly, refine your path and move with calm confidence. âœ¨",
  "Dear Members, good afternoon â˜€ï¸ If the week feels heavy, simplify your goals. Clear priorities strengthen momentum. Keep it structured. ğŸ“˜",
  "Dear Members, good afternoon ğŸŒ¼ Mondays flow better with order. Realign tasks and continue your day with steady, productive clarity. âœ”ï¸"
];

const THURSDAY_MEETUP = [
  "Dear Members, good afternoon ğŸ¤ Itâ€™s Thursday â€” a great day to ideate meetups. Share light thoughts or locations if youâ€™re interested. Collaboration begins with conversation. âœ¨",
  "Dear Members, good afternoon ğŸŒŸ Thursdays are ideal for exploring meetup ideas. Share simple suggestions or interest. Organic conversations build good connections. ğŸ¤",
  "Dear Members, good afternoon ğŸ¤ If you have meetup thoughts or plans, todayâ€™s a great moment to float them. Light sharing encourages collaboration. âœ¨",
  "Dear Members, good afternoon ğŸŒ¼ Thursday is for opening conversations. If youâ€™re thinking about joining or hosting a meetup, drop a note. Community grows through clarity. ğŸ¤"
];

const FRIDAY_MEETUP = [
  "Dear Members, good afternoon ğŸ“ Friday is for refining meetup ideas. Re-share clearly if you're interested so others can align smoothly. ğŸ¤",
  "Dear Members, good afternoon âœ¨ As we approach the weekend, refine your meetup details. Clear messages help others coordinate easily. ğŸ¤",
  "Dear Members, good afternoon ğŸ“ Perfect day to finalise meetup thoughts. Share concise updates so groups can form smoothly. âœ”ï¸",
  "Dear Members, good afternoon ğŸŒ¼ Friday clarity helps weekend meetups align better. Reconfirm your interest or share short details. ğŸ¤"
];

const SATURDAY_CONFIRM = [
  "Dear Members, good morning ğŸŒ Itâ€™s Saturday â€” the right moment to confirm meetups. Share quick details if youâ€™re planning or joining one. Clarity helps everyone. âœ¨",
  "Dear Members, good morning ğŸŒ¼ Saturday mornings are ideal for confirming meetups. Share simple plans so others can join easily. ğŸ¤",
  "Dear Members, good morning ğŸŒ If you're planning a meetup, send a quick confirmation. Clear updates help align the day smoothly. âœ”ï¸",
  "Dear Members, good morning ğŸŒ¿ A light Saturday reminder â€” finalize meetups early so coordination stays effortless. Share your plans briefly. âœ¨"
];

const SATURDAY_4PM = [
  "Dear Members, good evening ğŸŒ‡ Weekend is here. Prepare for your meetups or personal time. A short reset builds calm and balance. ğŸŒ¿",
  "Dear Members, good evening ğŸŒ¤ï¸ As the afternoon settles, take a moment to prepare for your evening plans or meetups. Calm organisation supports good experiences. âœ¨",
  "Dear Members, good evening ğŸŒ‡ Weekend rhythm begins now. Wrap light tasks and shift into a balanced, thoughtful evening. âœ”ï¸",
  "Dear Members, good evening ğŸŒ† A gentle nudge â€” prepare your meetup details or personal time for tonight. Small resets bring clarity. ğŸŒ¿"
];

const SATURDAY_8PM = [
  "Dear Members, good evening ğŸ“¸ Saturday evenings are perfect for sharing meetup pictures or meaningful moments. These exchanges build community warmth. âœ¨",
  "Dear Members, good evening ğŸŒ™ If you attended a meetup today, feel free to share a picture or highlight. These small shares bring us closer. ğŸ¤",
  "Dear Members, good evening âœ¨ Saturday nights are great for light reflections. Share a moment or photo if youâ€™d like â€” it adds warmth to the space. ğŸŒ¿",
  "Dear Members, good evening ğŸ“¸ A gentle reminder â€” meetup pictures or small moments from today are welcome. They help build community memories. âœ¨"
];

const SUNDAY_NOON = [
  "Dear Members, good afternoon ğŸŒ¼ Sunday is a great day to refresh mentally and physically. A light pause prepares you for the week ahead. ğŸŒ¿",
  "Dear Members, good afternoon âœ¨ Sundays are ideal for gentle resets. Organise lightly and give your mind space for the upcoming week. âœ”ï¸",
  "Dear Members, good afternoon ğŸŒ¿ Use today to unwind and reset. A small moment of clarity now supports a stronger Monday. ğŸ“˜",
  "Dear Members, good afternoon ğŸŒ¼ Take a mindful pause today. A calm Sunday prepares the mind for structured progress ahead. âœ¨"
];

const SUNDAY_EVENING = [
  "Dear Members, good evening ğŸŒ™ Letâ€™s prepare calmly for the upcoming week. A simple plan or short reflection creates a strong Monday. âœ¨",
  "Dear Members, good evening âœ¨ Wind down with clarity. A small plan tonight can make Monday smoother and more productive. âœ”ï¸",
  "Dear Members, good evening ğŸŒ™ A gentle reminder â€” prepare lightly for tomorrow. Mindful planning supports a strong week. ğŸŒ¿",
  "Dear Members, good evening ğŸŒŒ Ending the weekend with a moment of reflection builds a more focused Monday. Stay calm and intentional. âœ¨"
];

const DEFAULT_MORNING = [
  "Dear Members, good morning ğŸŒ… Letâ€™s begin the day with clarity and calm focus. A simple, intentional start sets strong momentum. âœ¨",
  "Dear Members, good morning ğŸŒ Wishing you a steady and productive day ahead. Small wins early in the day build confidence. âœ”ï¸",
  "Dear Members, good morning ğŸŒ¼ Letâ€™s approach the day with discipline and respectful communication. Strong habits create strong outcomes. ğŸŒ¿",
  "Dear Members, good morning ğŸŒ… A clear plan reduces stress and increases quality. Take a moment to align your priorities today. ğŸ“˜",
  "Dear Members, good morning ğŸŒ Progress comes from quiet, consistent action. Start light, move steady and maintain clarity. âœ¨",
  "Dear Members, good morning ğŸŒ… Each day offers a chance to refine habits. Letâ€™s use today well and stay mindful in our decisions. ğŸŒ¿",
  "Dear Members, good morning ğŸŒ¼ Begin today with intention. A few minutes of planning can save hours later. ğŸ“ˆ",
  "Dear Members, good morning ğŸŒ Wishing everyone a balanced and meaningful start. Consistency builds strong results. âœ¨",
  "Dear Members, good morning ğŸŒ… Letâ€™s stay organised and respectful in how we communicate today. Good culture builds good business. ğŸ¤",
  "Dear Members, good morning ğŸŒ¿ Take a calm breath and focus on the first important task. Clear starts create strong endings. âœ”ï¸",
  "Dear Members, good morning ğŸŒ A well-structured morning supports clarity throughout the day. Move gently, but purposefully. âœ¨",
  "Dear Members, good morning ğŸŒ… Letâ€™s make today light, intentional and productive in small, meaningful steps. ğŸŒ¿",
  "Dear Members, good morning ğŸŒ¼ Even one well-executed task sets a positive tone. Begin with something achievable. âœ”ï¸",
  "Dear Members, good morning ğŸŒ May today bring clarity and smooth progress in your work. Stay steady and thoughtful. âœ¨",
  "Dear Members, good morning ğŸŒ… Let's aim for calm productivity, not rush. A clear mind builds better decisions. ğŸŒ¿",
  "Dear Members, good morning ğŸŒ Wishing you a mindful start. Letâ€™s keep communication clean and purposeful today. ğŸ¤",
  "Dear Members, good morning ğŸŒ¼ A quiet morning routine builds strength for the entire day. Start focused, finish strong. ğŸ“˜",
  "Dear Members, good morning ğŸŒ Stay intentional today â€” clarity compounds. Make one decision that reduces tomorrowâ€™s load. âœ”ï¸",
  "Dear Members, good morning ğŸŒ… Letâ€™s stay aligned, ethical and respectful. Culture is built through everyday behaviour. âœ¨",
  "Dear Members, good morning ğŸŒ¼ Wishing you a grounded and organised morning. Simple efforts create reliable progress. ğŸŒ¿",
  "Dear Members, good morning ğŸŒ Productivity begins with clear thinking. Take a moment to reset and begin meaningfully. ğŸ“˜",
  "Dear Members, good morning ğŸŒ… Letâ€™s move with balance today â€” focused, calm and consistent in our work. âœ¨",
  "Dear Members, good morning ğŸŒ¼ May today bring constructive conversations and valuable insights. Keep sharing thoughtfully. ğŸ¤",
  "Dear Members, good morning ğŸŒ Letâ€™s uphold a modern, respectful communication style in all interactions today. ğŸŒ¿",
  "Dear Members, good morning ğŸŒ… A strong morning builds a strong day. Start with clarity and steady intention. âœ”ï¸",
  "Dear Members, good morning ğŸŒ¼ Letâ€™s use today to elevate our habits. Every good decision shapes tomorrow. âœ¨",
  "Dear Members, good morning ğŸŒ Letâ€™s keep this space professional, meaningful and noise-free. Quality over quantity. ğŸ¤",
  "Dear Members, good morning ğŸŒ… Prioritise what matters and release what doesnâ€™t. Mental clarity boosts performance. ğŸŒ¿",
  "Dear Members, good morning ğŸŒ A thoughtful start sets the rhythm for the entire day. Letâ€™s move with purpose. âœ”ï¸",
  "Dear Members, good morning ğŸŒ¼ Wishing everyone a constructive day ahead. Share learnings that may help others. âœ¨",
  "Dear Members, good morning ğŸŒ… Clarity grows quietly. Letâ€™s make room for organised thinking today. ğŸ“˜",
  "Dear Members, good morning ğŸŒ Letâ€™s maintain a professional and supportive tone throughout the day. Community grows through consistency. ğŸ¤",
  "Dear Members, good morning ğŸŒ¼ Begin today with calm determination. Steady progress beats rushed effort. ğŸŒ¿",
  "Dear Members, good morning ğŸŒ Wishing you a smooth and productive day. Keep things simple, focused and ethical. âœ”ï¸",
  "Dear Members, good morning ğŸŒ… A new day offers new clarity. Letâ€™s build it intentionally and respectfully. âœ¨"
];

const DEFAULT_NOON = [
  "Dear Members, good afternoon â˜€ï¸ Midday is a chance to reassess. Whatâ€™s one task you canâ€™t leave pending today? âœ”ï¸",
  "Dear Members, good afternoon ğŸŒ¿ A short pause helps realign priorities. Continue the day with mindful focus. âœ¨",
  "Dear Members, good afternoon ğŸ“˜ Review your progress and adjust your plan lightly. Clarity reduces stress. ğŸŒ¼",
  "Dear Members, good afternoon â˜€ï¸ If something feels stuck, simplify it. Break it into one actionable step. âœ”ï¸",
  "Dear Members, good afternoon âœ¨ A balanced mindset supports better decisions. Move forward with calm clarity. ğŸŒ¿",
  "Dear Members, good afternoon ğŸ“ˆ Letâ€™s maintain professional, meaningful communication throughout the day. ğŸ¤",
  "Dear Members, good afternoon â˜€ï¸ Midday resets help avoid evening overload. Realign and continue steadily. ğŸŒ¼",
  "Dear Members, good afternoon ğŸŒ¿ Choose one small win for the second half of your day. Momentum matters. âœ”ï¸",
  "Dear Members, good afternoon âœ¨ Even brief clarity can improve your entire workflow. Stay intentional. ğŸ“˜",
  "Dear Members, good afternoon â˜€ï¸ Keep communication thoughtful and respectful. It shapes our culture. ğŸ¤",
  "Dear Members, good afternoon ğŸŒ¿ Consider finishing one meaningful task today. Lighten tomorrowâ€™s load. âœ”ï¸",
  "Dear Members, good afternoon ğŸ“ˆ Midday discipline builds long-term results. Stay steady and organised. âœ¨",
  "Dear Members, good afternoon â˜€ï¸ Keep things structured. A clean process saves time and reduces stress. ğŸŒ¼",
  "Dear Members, good afternoon ğŸŒ¿ A clear mind supports strong decisions. Step back for a moment if needed. âœ¨",
  "Dear Members, good afternoon âœ¨ Stay focused on essentials. Small, consistent efforts compound beautifully. âœ”ï¸",
  "Dear Members, good afternoon â˜€ï¸ Letâ€™s maintain clarity and good behaviour. This space reflects our values. ğŸ¤",
  "Dear Members, good afternoon ğŸŒ¿ A brief reflection now can prevent late-day pressure. Keep it simple. âœ¨",
  "Dear Members, good afternoon ğŸ“˜ Reshape the rest of your day by finishing one priority item first. âœ”ï¸",
  "Dear Members, good afternoon â˜€ï¸ Re-check your to-do list and adjust lightly. Efficiency grows from clarity. ğŸŒ¼",
  "Dear Members, good afternoon ğŸŒ¿ Take a breath and continue with sharp focus. Small resets help. âœ¨",
  "Dear Members, good afternoon âœ¨ Letâ€™s stay constructive and forward-looking in our conversations today. ğŸ¤",
  "Dear Members, good afternoon â˜€ï¸ A mindful pause supports stronger work in the evening. Stay balanced. ğŸŒ¿",
  "Dear Members, good afternoon ğŸ“ˆ Organised thinking builds stable growth. Clear your desk, clear your mind. âœ”ï¸",
  "Dear Members, good afternoon âœ¨ Letâ€™s aim for a smooth, productive second half of the day. Stay intentional. ğŸ“˜",
  "Dear Members, good afternoon â˜€ï¸ If anything important is pending, this is the perfect time to address it. ğŸŒ¼",
  "Dear Members, good afternoon ğŸŒ¿ Strong habits outperform rush. Pace yourself with clarity. âœ¨",
  "Dear Members, good afternoon âœ¨ Letâ€™s keep our discussions meaningful and supportive. ğŸ¤",
  "Dear Members, good afternoon ğŸ“˜ A well-timed check-in keeps the day on track. Identify your next best task. âœ”ï¸",
  "Dear Members, good afternoon â˜€ï¸ Moving with calm focus builds confidence. Stay aligned with your goals. ğŸŒ¿",
  "Dear Members, good afternoon ğŸŒ¼ End your midday with a sense of direction â€” small clarity, big difference. âœ¨"
];

const DEFAULT_AFTERNOON = [
  "Dear Members, good evening ğŸŒ‡ As 4 PM approaches, letâ€™s close key tasks and end the day with clarity. âœ”ï¸",
  "Dear Members, good evening ğŸŒ¤ï¸ A strong finish creates a smoother tomorrow. Complete one pending item today. ğŸŒ¿",
  "Dear Members, good evening ğŸŒ‡ Bring calm focus to the last stretch of your day. Small closures reduce tomorrowâ€™s load. âœ¨",
  "Dear Members, good evening ğŸŒ† If anything is troubling or pending, share it briefly â€” someone may offer perspective. ğŸ¤",
  "Dear Members, good evening ğŸŒ¤ï¸ Letâ€™s wrap the day with purpose and clean communication. Professionalism builds trust. âœ”ï¸",
  "Dear Members, good evening ğŸŒ‡ Approaching the end of the day? Prioritise clarity over speed. Finish thoughtfully. ğŸŒ¿",
  "Dear Members, good evening ğŸŒ† Letâ€™s aim for a thoughtful close. Review whatâ€™s done and what can wait. âœ¨",
  "Dear Members, good evening ğŸŒ¤ï¸ Ending your day with one meaningful completion strengthens tomorrowâ€™s focus. âœ”ï¸",
  "Dear Members, good evening ğŸŒ‡ Keep things methodical and gentle in the last hour. Clarity beats urgency. ğŸŒ¿",
  "Dear Members, good evening ğŸŒ† A calm close supports a clear evening. Wrap up lightly and intentionally. âœ¨",
  "Dear Members, good evening ğŸŒ‡ If you need help finishing something today, ask â€” collaboration speeds clarity. ğŸ¤",
  "Dear Members, good evening ğŸŒ¤ï¸ Slow the pace and stay steady. End-of-day discipline builds long-term ease. âœ”ï¸",
  "Dear Members, good evening ğŸŒ† A clean wrap-up supports a clear mind. Decide what truly must finish today. ğŸŒ¿",
  "Dear Members, good evening ğŸŒ‡ Progress isnâ€™t about speed â€” itâ€™s about order. Close something small today. âœ¨",
  "Dear Members, good evening ğŸŒ¤ï¸ Finish the day with clarity. Choose one item, complete it, and breathe easy. âœ”ï¸",
  "Dear Members, good evening ğŸŒ‡ As we wind down, letâ€™s maintain a respectful, focused communication tone. ğŸ¤",
  "Dear Members, good evening ğŸŒ† Close your workday with calm alignment. Light organisation creates tomorrowâ€™s momentum. ğŸŒ¿",
  "Dear Members, good evening ğŸŒ‡ A structured finish reduces next-day stress. Take a moment to tidy your mental space. âœ¨",
  "Dear Members, good evening ğŸŒ¤ï¸ Make space for a smooth evening by completing whatâ€™s essential now. âœ”ï¸",
  "Dear Members, good evening ğŸŒ† Letâ€™s stay thoughtful and finish the day with balance and intention. ğŸŒ¿",
  "Dear Members, good evening ğŸŒ‡ Every small closure builds long-term stability. Wrap carefully. âœ¨",
  "Dear Members, good evening ğŸŒ¤ï¸ If something is delayed, give it a final push or reassign it. Clarity matters. âœ”ï¸",
  "Dear Members, good evening ğŸŒ† Bring your day to a meaningful close. Thoughtful decisions now support tomorrow. ğŸŒ¿",
  "Dear Members, good evening ğŸŒ‡ Letâ€™s wind down consciously. Calm productivity strengthens our community culture. âœ¨"
];

const DEFAULT_EVENING = [
  "Dear Members, good evening ğŸŒ™ As the day ends, share any challenge troubling you â€” someone here may offer quick perspective. ğŸ¤",
  "Dear Members, good evening âœ¨ Reflect and reset. A calm evening builds a stronger tomorrow. ğŸŒ¿",
  "Dear Members, good evening ğŸŒŒ Keep your night light and intentional. A peaceful end supports clarity. âœ”ï¸",
  "Dear Members, good evening ğŸŒ™ Todayâ€™s progress â€” big or small â€” deserves recognition. Rest well and prepare gently. ğŸ•Šï¸",
  "Dear Members, good evening âœ¨ Letâ€™s close the day with thoughtful communication and calm focus. ğŸŒ¿",
  "Dear Members, good evening ğŸŒŒ A short reflection strengthens tomorrowâ€™s clarity. What improved your day today? âœ”ï¸",
  "Dear Members, good evening ğŸŒ™ Stay relaxed and composed. A light evening rhythm supports better decisions tomorrow. ğŸŒ¿",
  "Dear Members, good evening âœ¨ Letâ€™s wind down respectfully and maintain the tone of our community. ğŸ¤",
  "Dear Members, good evening ğŸŒŒ If something remains unresolved, note it down for tomorrow. Free your mind tonight. ğŸ•Šï¸",
  "Dear Members, good evening ğŸŒ™ A calming routine tonight supports a productive morning. Move slowly and purposefully. âœ¨",
  "Dear Members, good evening âœ¨ Letâ€™s appreciate the small wins of today. Progress compounds quietly. ğŸŒ¿",
  "Dear Members, good evening ğŸŒŒ Keep the night peaceful. A settled mind creates stronger clarity tomorrow. âœ”ï¸",
  "Dear Members, good evening ğŸŒ™ Share a learning or insight if it may help someone. Collective progress matters. ğŸ¤",
  "Dear Members, good evening âœ¨ End the day with gentle reflection. Peace supports performance. ğŸŒ¿",
  "Dear Members, good evening ğŸŒŒ Letâ€™s stay mindful and prepare for tomorrow with balance and clarity. âœ”ï¸",
  "Dear Members, good evening ğŸŒ™ Set aside work calmly and allow yourself to unwind. A good close is as important as a good start. âœ¨",
  "Dear Members, good evening âœ¨ Slow the pace and breathe. Consistent calm builds stronger outcomes. ğŸŒ¿",
  "Dear Members, good evening ğŸŒŒ A peaceful night strengthens tomorrowâ€™s discipline. Stay gentle and focused. âœ”ï¸",
  "Dear Members, good evening ğŸŒ™ End the day with gratitude and intention. It shapes your next steps. âœ¨",
  "Dear Members, good evening âœ¨ Letâ€™s maintain respectful communication through the evening. Good culture is built daily. ğŸ¤",
  "Dear Members, good evening ğŸŒŒ A thoughtful close reduces stress. Keep the night organised and calm. âœ”ï¸",
  "Dear Members, good evening ğŸŒ™ Progress grows through balance. Rest well and start fresh tomorrow. ğŸŒ¿",
  "Dear Members, good evening âœ¨ Wishing you a calm and reflective evening. Gentle resets create strong days. ğŸŒ™",
  "Dear Members, good evening ğŸŒŒ Letâ€™s close the day lightly. Clarity comes from quiet moments. âœ”ï¸"
];

///////////////////////////////////////////////////////////////
// === PART 1: DATE / TIME HELPERS (ROBUST IST CONVERSION)
///////////////////////////////////////////////////////////////

function getISTDate() {
  const now = new Date();
  const utcMillis = now.getTime() + now.getTimezoneOffset() * 60000;
  const istOffsetMinutes = 330; // +5:30
  return new Date(utcMillis + istOffsetMinutes * 60000);
}

function formatMMDD(date) {
  const m = String(date.getMonth() + 1).padStart(2, "0");
  const d = String(date.getDate()).padStart(2, "0");
  return `${m}-${d}`;
}

function isLastDayOfMonth(date) {
  const test = new Date(date.getFullYear(), date.getMonth() + 1, 0);
  return date.getDate() === test.getDate();
}

function getISOWeek(date) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  return Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
}

///////////////////////////////////////////////////////////////
// === PART 2: SLOT NORMALIZATION + RESOLUTION
///////////////////////////////////////////////////////////////

function normalizeSlot(slot) {
  if (slot === "morning") return "morning";
  if (slot === "noon") return "noon";
  if (slot === "afternoon") return "afternoon";
  return "evening";
}

function getSpecialDayMessage(date, slot) {
  const mmdd = formatMMDD(date);
  const dayOfMonth = date.getDate();

  if (SPECIAL_FULL_DAY[mmdd]) {
    const block = SPECIAL_FULL_DAY[mmdd];
    if (slot === "morning" && block.morning) return block.morning;
    if (slot === "noon" && block.noon) return block.noon;
    if (slot === "afternoon" && block.afternoon) return block.afternoon;
    if (slot === "evening" && block.evening) return block.evening;
    if (slot === "midnight" && block.midnight) return block.midnight;
  }

  if (SPECIAL_SINGLE_SLOT[mmdd]) {
    const sd = SPECIAL_SINGLE_SLOT[mmdd];
    if (sd.slot === slot) return sd.message;
  }

  if (isLastDayOfMonth(date) && slot === "noon") {
    return "Dear Members, good afternoon â³ Month-end is here â€” a good time to close loose ends, clear backlogs and step into the new month with readiness. Let's finish strong. âœ”ï¸";
  }

  if (dayOfMonth === 1 && slot === "noon") {
    return "Dear Members, good afternoon ğŸŒŸ A new month begins. Letâ€™s restart with clear goals, fresh energy and steady discipline. Wishing you a focused month ahead. ğŸ“˜";
  }

  if (OBSERVANCE_DAYS[mmdd]) {
    const ob = OBSERVANCE_DAYS[mmdd];
    if (ob.slot === slot) return ob.message;
  }

  return null;
}

function getDayOfWeekMessage(date, slot) {
  const day = date.getDay();
  const weekIndex = getISOWeek(date) % 4;

  if (day === 0) {
    if (slot === "noon") return SUNDAY_NOON[weekIndex];
    if (slot === "evening") return SUNDAY_EVENING[weekIndex];
    return null;
  }

  if (day === 1) {
    if (slot === "morning") return MONDAY_MORNING[weekIndex];
    if (slot === "noon") return MONDAY_NOON[weekIndex];
  }

  if (day === 4 && slot === "noon") {
    return THURSDAY_MEETUP[weekIndex];
  }

  if (day === 5 && slot === "noon") {
    return FRIDAY_MEETUP[weekIndex];
  }

  if (day === 6) {
    if (slot === "morning") return SATURDAY_CONFIRM[weekIndex];
    if (slot === "afternoon") return SATURDAY_4PM[weekIndex];
    if (slot === "evening") return SATURDAY_8PM[weekIndex];
  }

  return null;
}

function getDefaultSlotMessage(slot) {
  if (slot === "morning") return DEFAULT_MORNING[Math.floor(Math.random() * DEFAULT_MORNING.length)];
  if (slot === "noon") return DEFAULT_NOON[Math.floor(Math.random() * DEFAULT_NOON.length)];
  if (slot === "afternoon") return DEFAULT_AFTERNOON[Math.floor(Math.random() * DEFAULT_AFTERNOON.length)];
  return DEFAULT_EVENING[Math.floor(Math.random() * DEFAULT_EVENING.length)];
}

function getMessageForSlot(slot, date = getISTDate()) {
  const normalized = normalizeSlot(slot);
  return (
    getSpecialDayMessage(date, normalized) ||
    getDayOfWeekMessage(date, normalized) ||
    getDefaultSlotMessage(normalized)
  );
}

///////////////////////////////////////////////////////////////
// === PART 3: TELEGRAM HELPERS
///////////////////////////////////////////////////////////////

const TELEGRAM_API_BASE = "https://api.telegram.org";

async function sendTelegramMessage(env, chatId, text, tries = 2) {
  const url = `${TELEGRAM_API_BASE}/bot${env.TELEGRAM_BOT_TOKEN}/sendMessage`;
  const payload = {
    chat_id: chatId,
    text,
    parse_mode: "HTML",
    disable_web_page_preview: true
  };

  for (let attempt = 1; attempt <= tries; attempt++) {
    try {
      const res = await fetch(url, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (res.ok) return true;
    } catch {}
  }
  return false;
}

///////////////////////////////////////////////////////////////
// >>> SILENT HOURS ADDITION: CHAT PERMISSIONS
///////////////////////////////////////////////////////////////

async function setChatPosting(env, chatId, canPost) {
  const url = `${TELEGRAM_API_BASE}/bot${env.TELEGRAM_BOT_TOKEN}/setChatPermissions`;
  return fetch(url, {
    method: "POST",
    headers: { "content-type": "application/json" },
    body: JSON.stringify({
      chat_id: chatId,
      permissions: { can_send_messages: canPost }
    })
  });
}

///////////////////////////////////////////////////////////////
// === PART 4: CRON MAPPING + SCHEDULE HANDLING
///////////////////////////////////////////////////////////////

function cronToSlot(expr) {
  switch (expr) {
    case "30 2 * * *":  return "morning";
    case "30 6 * * *":  return "noon";
    case "30 10 * * *": return "afternoon";
    case "30 14 * * *": return "evening";
    case "30 16 * * *": return "silent"; // >>> SILENT HOURS
    default:
      return null;
  }
}

async function handleScheduled(event, env) {
  const slot = cronToSlot(event.cron);
  if (!slot) return;

  const date = getISTDate();

  // >>> SILENT HOURS: 10 PM close + notify
  if (slot === "silent") {
    await setChatPosting(env, env.TELEGRAM_GROUP_ID, false);
    await sendTelegramMessage(env, env.TELEGRAM_GROUP_ID, SILENT_HOURS_MESSAGE);
    return;
  }

  // >>> SILENT HOURS: 8 AM reopen silently
  if (slot === "morning") {
    await setChatPosting(env, env.TELEGRAM_GROUP_ID, true);
  }

  // Existing Sunday morning suppression
  if (date.getDay() === 0 && slot === "morning") return;

  const message = getMessageForSlot(slot, date);
  if (!message) return;

  await sendTelegramMessage(env, env.TELEGRAM_GROUP_ID, message);
}

///////////////////////////////////////////////////////////////
// === PART 6: EXPORT
///////////////////////////////////////////////////////////////

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    if (request.method === "GET" && url.pathname === "/") {
      return new Response("KenFolios + VStreet Broadcast Worker is alive.", {
        status: 200,
        headers: { "content-type": "text/plain" }
      });
    }
    return new Response("Not found", { status: 404 });
  },

  async scheduled(event, env, ctx) {
    ctx.waitUntil(handleScheduled(event, env));
  }
};

