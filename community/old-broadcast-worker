/**
 * KENFOLIOS + VSTREET TELEGRAM BROADCAST WORKER
 *
 * Full worker file â€” drop into Cloudflare Workers (module).
 * Make sure to set the environment secrets:
 *   - TELEGRAM_BOT_TOKEN
 *   - TELEGRAM_GROUP_ID
 *   - TELEGRAM_WEBHOOK_SECRET
 *
 * Cron triggers to add (UTC cron lines):
 *   30 02 * * *   -> 08:00 IST (morning)
 *   30 06 * * *   -> 12:00 IST (noon)
 *   30 10 * * *   -> 16:00 IST (afternoon)
 *   30 14 * * *   -> 20:00 IST (evening)
 *
 * Note: keep tokens/secrets in Cloudflare secrets (not in code).
 */

///////////////////////////////////////////////////////////////
// === PART 0: MESSAGE POOLS & CONFIG (UNCHANGED FROM YOUR SPEC)
///////////////////////////////////////////////////////////////

const SPECIAL_FULL_DAY = {
  "01-26": {
    morning: "Dear Members, good morning ðŸ‡®ðŸ‡³ Today we celebrate Republic Day â€” a reminder of discipline, integrity and collective progress. Letâ€™s move through the day with clarity and professionalism. ðŸŒŸ",
    noon: "Dear Members, good afternoon ðŸ‡®ðŸ‡³ On Republic Day, letâ€™s appreciate the systems that enable modern business and the responsibility we hold to strengthen them through ethical work. ðŸ¤",
    afternoon: "Dear Members, good evening ðŸ‡®ðŸ‡³ As we wrap our workday, letâ€™s close one meaningful task and strengthen our progress today. Small actions build strong culture. ðŸŒ¿",
    evening: "Dear Members, good evening ðŸ‡®ðŸ‡³ Let's end Republic Day with gratitude and clarity as we prepare for a new day. Professionalism and respect build strong communities. ðŸŒ™"
  },

  "08-15": {
    morning: "Dear Members, good morning ðŸ‡®ðŸ‡³ Independence Day reminds us to build with purpose and honesty. Letâ€™s use our work to strengthen Indiaâ€™s ecosystem and move forward with clarity. ðŸŒ…",
    noon: "Dear Members, good afternoon ðŸ‡®ðŸ‡³ On this day of freedom, letâ€™s honour self-reliance by supporting one another through ethical collaboration and thoughtful communication. ðŸ¤",
    afternoon: "Dear Members, good evening ðŸ‡®ðŸ‡³ As we close our workday, letâ€™s complete one meaningful task that reflects growth and responsibility. Small wins matter. ðŸŒ¿",
    evening: "Dear Members, good evening ðŸ‡®ðŸ‡³ Ending Independence Day with gratitude and renewed focus helps us build cleaner, stronger business culture. ðŸŒ™"
  },

  "12-31": {
    morning: "Dear Members, good morning ðŸŒ… It's the final day of the year. Letâ€™s reflect on learnings and close the year with clarity. Small improvements today set a better tone for tomorrow. âœ¨",
    noon: "Dear Members, good afternoon ðŸŒž Year-end is a great moment to finish pending tasks and clear space for new beginnings. A tidy mind creates strong outcomes. ðŸ“‚",
    afternoon: "Dear Members, good evening ðŸŒ‡ The final hours of the year are here. If something is unresolved, share it â€” someone may offer a quick perspective. Collaboration builds clarity. ðŸ¤",
    evening: "Dear Members, good evening ðŸŒ™ As we close the year, letâ€™s acknowledge progress and appreciate resilience. Wishing you a peaceful transition into the new year. ðŸŒŸ",
    midnight: "Dear Members, happy new year ðŸŽ‰ Wishing you clarity, discipline and meaningful progress. Letâ€™s build stronger systems and support each otherâ€™s journey. âœ¨"
  },

  "01-01": {
    morning: "Dear Members, good morning ðŸŽ‰ A new year begins with intention and clarity. Wishing you a meaningful and disciplined year ahead. Letâ€™s build with purpose. ðŸŒŸ",
    noon: "Dear Members, good afternoon âœ¨ Today is a moment to outline simple, achievable priorities for the year. Consistency builds strong outcomes. ðŸ“˜",
    afternoon: "Dear Members, good evening ðŸŒ‡ As the first workday progresses, complete one important task to set the tone for the year ahead. âœ”ï¸",
    evening: "Dear Members, good evening ðŸŒ™ A peaceful close to Day 1. Reflect, reset and prepare for tomorrow. Growth is built daily. ðŸŒ¿"
  }
};

const SPECIAL_SINGLE_SLOT = {
  "03-31": {
    slot: "noon",
    message: "Dear Members, good afternoon ðŸ“Š Today marks the financial year end â€” a strong moment to wrap pending tasks and prepare a clean slate for tomorrow. Steady clarity builds strong years. âœ¨"
  },

  "04-01": {
    slot: "noon",
    message: "Dear Members, good afternoon ðŸŒ± A new financial year begins today. Letâ€™s step in with disciplined planning, ethical intent and long-term focus. Wishing everyone a strong year ahead. ðŸ“ˆ"
  }
};

const OBSERVANCE_DAYS = {
  "05-01": { slot: "noon", message: "Dear Members, good afternoon ðŸ’¼ On Labour Day, we acknowledge the dignity of disciplined work and the value of collaboration. Letâ€™s keep building a community rooted in clarity and professionalism. ðŸ¤" },
  "06-27": { slot: "noon", message: "Dear Members, good afternoon ðŸ“ˆ Today is MSME Day â€” a reminder that small and mid-sized businesses drive growth. Letâ€™s support each other with knowledge and ethical collaboration. ðŸŒŸ" },
  "06-30": { slot: "noon", message: "Dear Members, good afternoon ðŸŒ Social Media Day reminds us that clarity and context build meaningful connections. Letâ€™s communicate thoughtfully and professionally. âœ¨" },
  "04-28": { slot: "noon", message: "Dear Members, good afternoon ðŸ¦º Workplace Safety Day highlights the importance of safe, organised and healthy environments. Small improvements create long-term productivity. âœ”ï¸" },
  "06-05": { slot: "morning", message: "Dear Members, good morning ðŸŒ± World Environment Day reminds us how daily choices shape a healthier future. Letâ€™s reduce waste and build responsible businesses. ðŸŒ" },
  "06-21": { slot: "morning", message: "Dear Members, good morning ðŸ§˜â€â™‚ï¸ Yoga Day encourages balance in work and life. A few minutes of calm or stretching can improve clarity and energy. Start light today. ðŸŒž" },
  "01-24": { slot: "noon", message: "Dear Members, good afternoon ðŸŽ“ Education Day reminds us that continuous learning strengthens decisions and growth. Letâ€™s share insights that elevate our community. ðŸŒŸ" },
  "04-07": { slot: "morning", message: "Dear Members, good morning â¤ï¸ World Health Day reminds us that physical and mental well-being fuels strong decisions. Letâ€™s stay mindful today. ðŸŒ¿" },
  "09-29": { slot: "morning", message: "Dear Members, good morning â¤ï¸â€ðŸ©¹ On World Heart Day, letâ€™s be mindful of choices that support long-term health. Healthy decisions strengthen our clarity and work. ðŸŒ¿" },
  "10-10": { slot: "noon", message: "Dear Members, good afternoon ðŸ’š On World Mental Health Day, letâ€™s pause, reflect and maintain balance. Healthy minds build healthy decisions. ðŸŒ±" },
  "11-14": { slot: "noon", message: "Dear Members, good afternoon ðŸŒ¿ On Diabetes Day, letâ€™s stay mindful of habits that support long-term well-being. Balanced living strengthens our clarity and focus. âœ¨" },
  "02-04": { slot: "noon", message: "Dear Members, good afternoon ðŸŽ—ï¸ World Cancer Day reminds us of compassion, awareness and support. Health and empathy strengthen communities. ðŸŒ¼" },
  "12-03": { slot: "noon", message: "Dear Members, good afternoon â™¿ Disability Day highlights inclusion and thoughtful support. Respectful communication strengthens every professional space. ðŸ¤" },
  "12-01": { slot: "noon", message: "Dear Members, good afternoon ðŸŽ—ï¸ Today is World AIDS Day â€” a reminder to stay informed, compassionate and responsible. Awareness builds safer societies. ðŸŒ¿" },
  "01-30": { slot: "noon", message: "Dear Members, good afternoon ðŸ•Šï¸ Martyrsâ€™ Day invites quiet reflection. Letâ€™s honour integrity and stay mindful of values that guide ethical work. âœ¨" },
  "05-11": { slot: "noon", message: "Dear Members, good afternoon ðŸ¤– National Technology Day celebrates innovation. Letâ€™s explore ideas that make our work smarter, cleaner and more efficient. âš¡" },
  "02-28": { slot: "noon", message: "Dear Members, good afternoon ðŸ”¬ National Science Day reminds us how curiosity and knowledge shape better solutions. Letâ€™s keep learning. ðŸŒŸ" },
  "04-23": { slot: "noon", message: "Dear Members, good afternoon ðŸ“˜ World Book Day reminds us of the power of reading. One strong idea can transform how we think and work. ðŸŒ±" },
  "11-12": { slot: "noon", message: "Dear Members, good afternoon â­ World Quality Day highlights that clarity, precision and discipline create strong systems. Letâ€™s improve one small thing today. âœ”ï¸" },
  "09-15": { slot: "morning", message: "Dear Members, good morning ðŸ› ï¸ Happy Engineers Day! Today we appreciate those who build and solve. Strong systems come from thoughtful engineering in work and life. ðŸŒŸ" },
  "09-08": { slot: "noon", message: "Dear Members, good afternoon ðŸ“– On International Literacy Day, letâ€™s value learning and clarity. Literacy strengthens decision-making and professional growth. âœ¨" },
  "05-31": { slot: "noon", message: "Dear Members, good afternoon ðŸŒ¿ World No Tobacco Day reminds us to prioritise long-term health. Healthy habits support strong thinking and sustainable performance. ðŸŒ±" },
  "03-15": { slot: "noon", message: "Dear Members, good afternoon ðŸ›¡ï¸ World Consumer Rights Day highlights transparency and fairness. Letâ€™s maintain honest, ethical practices in all interactions. ðŸ¤" },
  "02-20": { slot: "noon", message: "Dear Members, good afternoon ðŸŒ World Social Justice Day reminds us that fairness and balance strengthen communities and workplaces. Letâ€™s act responsibly. âœ¨" },
  "03-08": { slot: "noon", message: "Dear Members, good afternoon ðŸŒ¼ Todayâ€™s observance reminds us to build inclusive, respectful spaces where clarity, ethics and professionalism guide our actions." },
  "06-14": { slot: "morning", message: "Dear Members, good morning â¤ï¸ Today is World Blood Donor Day â€” a reminder of generosity and community strength. Letâ€™s appreciate those who support life and health. ðŸŒ¿" },
  "12-05": { slot: "noon", message: "Dear Members, good afternoon ðŸŒ± International Volunteer Day celebrates selfless service. Small acts of support strengthen community trust. ðŸ¤" },
  "06-08": { slot: "morning", message: "Dear Members, good morning ðŸŒŠ World Oceans Day reminds us to protect natural systems that support life and business. Mindful choices matter. ðŸŒ" },
  "03-21": { slot: "morning", message: "Dear Members, good morning ðŸŒ¿ International Day of Forests highlights how natural resources support our future. Letâ€™s value sustainability in decisions. ðŸŒ±" }
};

const MONDAY_MORNING = [
  "Dear Members, good morning ðŸŒ… Itâ€™s a fresh week â€” a clean slate to build clarity, discipline and steady momentum. Start meaningfully. âœ¨",
  "Dear Members, good morning ðŸŒž A new week begins â€” reset lightly, organise your thoughts and take one calm step toward progress. Consistency builds strength. âœ¨",
  "Dear Members, good morning ðŸŒ… Mondays set the tone. Begin with clarity, refine priorities and move with steady focus. One strong start shapes the week. âœ”ï¸",
  "Dear Members, good morning ðŸŒ¼ Letâ€™s enter the week with balance and structure. A simple plan today creates smoother days ahead. Build calmly and intentionally. ðŸŒ¿"
];

const MONDAY_NOON = [
  "Dear Members, good afternoon â˜€ï¸ Letâ€™s gear up for the week. A quick plan and clean priorities build strong direction. âœ”ï¸",
  "Dear Members, good afternoon ðŸŒ¿ Midday check-ins help shape the week ahead. Review lightly, refine your path and move with calm confidence. âœ¨",
  "Dear Members, good afternoon â˜€ï¸ If the week feels heavy, simplify your goals. Clear priorities strengthen momentum. Keep it structured. ðŸ“˜",
  "Dear Members, good afternoon ðŸŒ¼ Mondays flow better with order. Realign tasks and continue your day with steady, productive clarity. âœ”ï¸"
];

const THURSDAY_MEETUP = [
  "Dear Members, good afternoon ðŸ¤ Itâ€™s Thursday â€” a great day to ideate meetups. Share light thoughts or locations if youâ€™re interested. Collaboration begins with conversation. âœ¨",
  "Dear Members, good afternoon ðŸŒŸ Thursdays are ideal for exploring meetup ideas. Share simple suggestions or interest. Organic conversations build good connections. ðŸ¤",
  "Dear Members, good afternoon ðŸ¤ If you have meetup thoughts or plans, todayâ€™s a great moment to float them. Light sharing encourages collaboration. âœ¨",
  "Dear Members, good afternoon ðŸŒ¼ Thursday is for opening conversations. If youâ€™re thinking about joining or hosting a meetup, drop a note. Community grows through clarity. ðŸ¤"
];

const FRIDAY_MEETUP = [
  "Dear Members, good afternoon ðŸ“ Friday is for refining meetup ideas. Re-share clearly if you're interested so others can align smoothly. ðŸ¤",
  "Dear Members, good afternoon âœ¨ As we approach the weekend, refine your meetup details. Clear messages help others coordinate easily. ðŸ¤",
  "Dear Members, good afternoon ðŸ“ Perfect day to finalise meetup thoughts. Share concise updates so groups can form smoothly. âœ”ï¸",
  "Dear Members, good afternoon ðŸŒ¼ Friday clarity helps weekend meetups align better. Reconfirm your interest or share short details. ðŸ¤"
];

const SATURDAY_CONFIRM = [
  "Dear Members, good morning ðŸŒž Itâ€™s Saturday â€” the right moment to confirm meetups. Share quick details if youâ€™re planning or joining one. Clarity helps everyone. âœ¨",
  "Dear Members, good morning ðŸŒ¼ Saturday mornings are ideal for confirming meetups. Share simple plans so others can join easily. ðŸ¤",
  "Dear Members, good morning ðŸŒž If you're planning a meetup, send a quick confirmation. Clear updates help align the day smoothly. âœ”ï¸",
  "Dear Members, good morning ðŸŒ¿ A light Saturday reminder â€” finalize meetups early so coordination stays effortless. Share your plans briefly. âœ¨"
];

const SATURDAY_4PM = [
  "Dear Members, good evening ðŸŒ‡ Weekend is here. Prepare for your meetups or personal time. A short reset builds calm and balance. ðŸŒ¿",
  "Dear Members, good evening ðŸŒ¤ï¸ As the afternoon settles, take a moment to prepare for your evening plans or meetups. Calm organisation supports good experiences. âœ¨",
  "Dear Members, good evening ðŸŒ‡ Weekend rhythm begins now. Wrap light tasks and shift into a balanced, thoughtful evening. âœ”ï¸",
  "Dear Members, good evening ðŸŒ† A gentle nudge â€” prepare your meetup details or personal time for tonight. Small resets bring clarity. ðŸŒ¿"
];

const SATURDAY_8PM = [
  "Dear Members, good evening ðŸ“¸ Saturday evenings are perfect for sharing meetup pictures or meaningful moments. These exchanges build community warmth. âœ¨",
  "Dear Members, good evening ðŸŒ™ If you attended a meetup today, feel free to share a picture or highlight. These small shares bring us closer. ðŸ¤",
  "Dear Members, good evening âœ¨ Saturday nights are great for light reflections. Share a moment or photo if youâ€™d like â€” it adds warmth to the space. ðŸŒ¿",
  "Dear Members, good evening ðŸ“¸ A gentle reminder â€” meetup pictures or small moments from today are welcome. They help build community memories. âœ¨"
];

const SUNDAY_NOON = [
  "Dear Members, good afternoon ðŸŒ¼ Sunday is a great day to refresh mentally and physically. A light pause prepares you for the week ahead. ðŸŒ¿",
  "Dear Members, good afternoon âœ¨ Sundays are ideal for gentle resets. Organise lightly and give your mind space for the upcoming week. âœ”ï¸",
  "Dear Members, good afternoon ðŸŒ¿ Use today to unwind and reset. A small moment of clarity now supports a stronger Monday. ðŸ“˜",
  "Dear Members, good afternoon ðŸŒ¼ Take a mindful pause today. A calm Sunday prepares the mind for structured progress ahead. âœ¨"
];

const SUNDAY_EVENING = [
  "Dear Members, good evening ðŸŒ™ Letâ€™s prepare calmly for the upcoming week. A simple plan or short reflection creates a strong Monday. âœ¨",
  "Dear Members, good evening âœ¨ Wind down with clarity. A small plan tonight can make Monday smoother and more productive. âœ”ï¸",
  "Dear Members, good evening ðŸŒ™ A gentle reminder â€” prepare lightly for tomorrow. Mindful planning supports a strong week. ðŸŒ¿",
  "Dear Members, good evening ðŸŒŒ Ending the weekend with a moment of reflection builds a more focused Monday. Stay calm and intentional. âœ¨"
];

const DEFAULT_MORNING = [
  "Dear Members, good morning ðŸŒ… Letâ€™s begin the day with clarity and calm focus. A simple, intentional start sets strong momentum. âœ¨",
  "Dear Members, good morning ðŸŒž Wishing you a steady and productive day ahead. Small wins early in the day build confidence. âœ”ï¸",
  "Dear Members, good morning ðŸŒ¼ Letâ€™s approach the day with discipline and respectful communication. Strong habits create strong outcomes. ðŸŒ¿",
  "Dear Members, good morning ðŸŒ… A clear plan reduces stress and increases quality. Take a moment to align your priorities today. ðŸ“˜",
  "Dear Members, good morning ðŸŒž Progress comes from quiet, consistent action. Start light, move steady and maintain clarity. âœ¨",
  "Dear Members, good morning ðŸŒ… Each day offers a chance to refine habits. Letâ€™s use today well and stay mindful in our decisions. ðŸŒ¿",
  "Dear Members, good morning ðŸŒ¼ Begin today with intention. A few minutes of planning can save hours later. ðŸ“ˆ",
  "Dear Members, good morning ðŸŒž Wishing everyone a balanced and meaningful start. Consistency builds strong results. âœ¨",
  "Dear Members, good morning ðŸŒ… Letâ€™s stay organised and respectful in how we communicate today. Good culture builds good business. ðŸ¤",
  "Dear Members, good morning ðŸŒ¿ Take a calm breath and focus on the first important task. Clear starts create strong endings. âœ”ï¸",
  "Dear Members, good morning ðŸŒž A well-structured morning supports clarity throughout the day. Move gently, but purposefully. âœ¨",
  "Dear Members, good morning ðŸŒ… Letâ€™s make today light, intentional and productive in small, meaningful steps. ðŸŒ¿",
  "Dear Members, good morning ðŸŒ¼ Even one well-executed task sets a positive tone. Begin with something achievable. âœ”ï¸",
  "Dear Members, good morning ðŸŒž May today bring clarity and smooth progress in your work. Stay steady and thoughtful. âœ¨",
  "Dear Members, good morning ðŸŒ… Let's aim for calm productivity, not rush. A clear mind builds better decisions. ðŸŒ¿",
  "Dear Members, good morning ðŸŒž Wishing you a mindful start. Letâ€™s keep communication clean and purposeful today. ðŸ¤",
  "Dear Members, good morning ðŸŒ¼ A quiet morning routine builds strength for the entire day. Start focused, finish strong. ðŸ“˜",
  "Dear Members, good morning ðŸŒž Stay intentional today â€” clarity compounds. Make one decision that reduces tomorrowâ€™s load. âœ”ï¸",
  "Dear Members, good morning ðŸŒ… Letâ€™s stay aligned, ethical and respectful. Culture is built through everyday behaviour. âœ¨",
  "Dear Members, good morning ðŸŒ¼ Wishing you a grounded and organised morning. Simple efforts create reliable progress. ðŸŒ¿",
  "Dear Members, good morning ðŸŒž Productivity begins with clear thinking. Take a moment to reset and begin meaningfully. ðŸ“˜",
  "Dear Members, good morning ðŸŒ… Letâ€™s move with balance today â€” focused, calm and consistent in our work. âœ¨",
  "Dear Members, good morning ðŸŒ¼ May today bring constructive conversations and valuable insights. Keep sharing thoughtfully. ðŸ¤",
  "Dear Members, good morning ðŸŒž Letâ€™s uphold a modern, respectful communication style in all interactions today. ðŸŒ¿",
  "Dear Members, good morning ðŸŒ… A strong morning builds a strong day. Start with clarity and steady intention. âœ”ï¸",
  "Dear Members, good morning ðŸŒ¼ Letâ€™s use today to elevate our habits. Every good decision shapes tomorrow. âœ¨",
  "Dear Members, good morning ðŸŒž Letâ€™s keep this space professional, meaningful and noise-free. Quality over quantity. ðŸ¤",
  "Dear Members, good morning ðŸŒ… Prioritise what matters and release what doesnâ€™t. Mental clarity boosts performance. ðŸŒ¿",
  "Dear Members, good morning ðŸŒž A thoughtful start sets the rhythm for the entire day. Letâ€™s move with purpose. âœ”ï¸",
  "Dear Members, good morning ðŸŒ¼ Wishing everyone a constructive day ahead. Share learnings that may help others. âœ¨",
  "Dear Members, good morning ðŸŒ… Clarity grows quietly. Letâ€™s make room for organised thinking today. ðŸ“˜",
  "Dear Members, good morning ðŸŒž Letâ€™s maintain a professional and supportive tone throughout the day. Community grows through consistency. ðŸ¤",
  "Dear Members, good morning ðŸŒ¼ Begin today with calm determination. Steady progress beats rushed effort. ðŸŒ¿",
  "Dear Members, good morning ðŸŒž Wishing you a smooth and productive day. Keep things simple, focused and ethical. âœ”ï¸",
  "Dear Members, good morning ðŸŒ… A new day offers new clarity. Letâ€™s build it intentionally and respectfully. âœ¨"
];

const DEFAULT_NOON = [
  "Dear Members, good afternoon â˜€ï¸ Midday is a chance to reassess. Whatâ€™s one task you canâ€™t leave pending today? âœ”ï¸",
  "Dear Members, good afternoon ðŸŒ¿ A short pause helps realign priorities. Continue the day with mindful focus. âœ¨",
  "Dear Members, good afternoon ðŸ“˜ Review your progress and adjust your plan lightly. Clarity reduces stress. ðŸŒ¼",
  "Dear Members, good afternoon â˜€ï¸ If something feels stuck, simplify it. Break it into one actionable step. âœ”ï¸",
  "Dear Members, good afternoon âœ¨ A balanced mindset supports better decisions. Move forward with calm clarity. ðŸŒ¿",
  "Dear Members, good afternoon ðŸ“ˆ Letâ€™s maintain professional, meaningful communication throughout the day. ðŸ¤",
  "Dear Members, good afternoon â˜€ï¸ Midday resets help avoid evening overload. Realign and continue steadily. ðŸŒ¼",
  "Dear Members, good afternoon ðŸŒ¿ Choose one small win for the second half of your day. Momentum matters. âœ”ï¸",
  "Dear Members, good afternoon âœ¨ Even brief clarity can improve your entire workflow. Stay intentional. ðŸ“˜",
  "Dear Members, good afternoon â˜€ï¸ Keep communication thoughtful and respectful. It shapes our culture. ðŸ¤",
  "Dear Members, good afternoon ðŸŒ¿ Consider finishing one meaningful task today. Lighten tomorrowâ€™s load. âœ”ï¸",
  "Dear Members, good afternoon ðŸ“ˆ Midday discipline builds long-term results. Stay steady and organised. âœ¨",
  "Dear Members, good afternoon â˜€ï¸ Keep things structured. A clean process saves time and reduces stress. ðŸŒ¼",
  "Dear Members, good afternoon ðŸŒ¿ A clear mind supports strong decisions. Step back for a moment if needed. âœ¨",
  "Dear Members, good afternoon âœ¨ Stay focused on essentials. Small, consistent efforts compound beautifully. âœ”ï¸",
  "Dear Members, good afternoon â˜€ï¸ Letâ€™s maintain clarity and good behaviour. This space reflects our values. ðŸ¤",
  "Dear Members, good afternoon ðŸŒ¿ A brief reflection now can prevent late-day pressure. Keep it simple. âœ¨",
  "Dear Members, good afternoon ðŸ“˜ Reshape the rest of your day by finishing one priority item first. âœ”ï¸",
  "Dear Members, good afternoon â˜€ï¸ Re-check your to-do list and adjust lightly. Efficiency grows from clarity. ðŸŒ¼",
  "Dear Members, good afternoon ðŸŒ¿ Take a breath and continue with sharp focus. Small resets help. âœ¨",
  "Dear Members, good afternoon âœ¨ Letâ€™s stay constructive and forward-looking in our conversations today. ðŸ¤",
  "Dear Members, good afternoon â˜€ï¸ A mindful pause supports stronger work in the evening. Stay balanced. ðŸŒ¿",
  "Dear Members, good afternoon ðŸ“ˆ Organised thinking builds stable growth. Clear your desk, clear your mind. âœ”ï¸",
  "Dear Members, good afternoon âœ¨ Letâ€™s aim for a smooth, productive second half of the day. Stay intentional. ðŸ“˜",
  "Dear Members, good afternoon â˜€ï¸ If anything important is pending, this is the perfect time to address it. ðŸŒ¼",
  "Dear Members, good afternoon ðŸŒ¿ Strong habits outperform rush. Pace yourself with clarity. âœ¨",
  "Dear Members, good afternoon âœ¨ Letâ€™s keep our discussions meaningful and supportive. ðŸ¤",
  "Dear Members, good afternoon ðŸ“˜ A well-timed check-in keeps the day on track. Identify your next best task. âœ”ï¸",
  "Dear Members, good afternoon â˜€ï¸ Moving with calm focus builds confidence. Stay aligned with your goals. ðŸŒ¿",
  "Dear Members, good afternoon ðŸŒ¼ End your midday with a sense of direction â€” small clarity, big difference. âœ¨"
];

const DEFAULT_AFTERNOON = [
  "Dear Members, good evening ðŸŒ‡ As 4 PM approaches, letâ€™s close key tasks and end the day with clarity. âœ”ï¸",
  "Dear Members, good evening ðŸŒ¤ï¸ A strong finish creates a smoother tomorrow. Complete one pending item today. ðŸŒ¿",
  "Dear Members, good evening ðŸŒ‡ Bring calm focus to the last stretch of your day. Small closures reduce tomorrowâ€™s load. âœ¨",
  "Dear Members, good evening ðŸŒ† If anything is troubling or pending, share it briefly â€” someone may offer perspective. ðŸ¤",
  "Dear Members, good evening ðŸŒ¤ï¸ Letâ€™s wrap the day with purpose and clean communication. Professionalism builds trust. âœ”ï¸",
  "Dear Members, good evening ðŸŒ‡ Approaching the end of the day? Prioritise clarity over speed. Finish thoughtfully. ðŸŒ¿",
  "Dear Members, good evening ðŸŒ† Letâ€™s aim for a thoughtful close. Review whatâ€™s done and what can wait. âœ¨",
  "Dear Members, good evening ðŸŒ¤ï¸ Ending your day with one meaningful completion strengthens tomorrowâ€™s focus. âœ”ï¸",
  "Dear Members, good evening ðŸŒ‡ Keep things methodical and gentle in the last hour. Clarity beats urgency. ðŸŒ¿",
  "Dear Members, good evening ðŸŒ† A calm close supports a clear evening. Wrap up lightly and intentionally. âœ¨",
  "Dear Members, good evening ðŸŒ‡ If you need help finishing something today, ask â€” collaboration speeds clarity. ðŸ¤",
  "Dear Members, good evening ðŸŒ¤ï¸ Slow the pace and stay steady. End-of-day discipline builds long-term ease. âœ”ï¸",
  "Dear Members, good evening ðŸŒ† A clean wrap-up supports a clear mind. Decide what truly must finish today. ðŸŒ¿",
  "Dear Members, good evening ðŸŒ‡ Progress isnâ€™t about speed â€” itâ€™s about order. Close something small today. âœ¨",
  "Dear Members, good evening ðŸŒ¤ï¸ Finish the day with clarity. Choose one item, complete it, and breathe easy. âœ”ï¸",
  "Dear Members, good evening ðŸŒ‡ As we wind down, letâ€™s maintain a respectful, focused communication tone. ðŸ¤",
  "Dear Members, good evening ðŸŒ† Close your workday with calm alignment. Light organisation creates tomorrowâ€™s momentum. ðŸŒ¿",
  "Dear Members, good evening ðŸŒ‡ A structured finish reduces next-day stress. Take a moment to tidy your mental space. âœ¨",
  "Dear Members, good evening ðŸŒ¤ï¸ Make space for a smooth evening by completing whatâ€™s essential now. âœ”ï¸",
  "Dear Members, good evening ðŸŒ† Letâ€™s stay thoughtful and finish the day with balance and intention. ðŸŒ¿",
  "Dear Members, good evening ðŸŒ‡ Every small closure builds long-term stability. Wrap carefully. âœ¨",
  "Dear Members, good evening ðŸŒ¤ï¸ If something is delayed, give it a final push or reassign it. Clarity matters. âœ”ï¸",
  "Dear Members, good evening ðŸŒ† Bring your day to a meaningful close. Thoughtful decisions now support tomorrow. ðŸŒ¿",
  "Dear Members, good evening ðŸŒ‡ Letâ€™s wind down consciously. Calm productivity strengthens our community culture. âœ¨"
];

const DEFAULT_EVENING = [
  "Dear Members, good evening ðŸŒ™ As the day ends, share any challenge troubling you â€” someone here may offer quick perspective. ðŸ¤",
  "Dear Members, good evening âœ¨ Reflect and reset. A calm evening builds a stronger tomorrow. ðŸŒ¿",
  "Dear Members, good evening ðŸŒŒ Keep your night light and intentional. A peaceful end supports clarity. âœ”ï¸",
  "Dear Members, good evening ðŸŒ™ Todayâ€™s progress â€” big or small â€” deserves recognition. Rest well and prepare gently. ðŸ•Šï¸",
  "Dear Members, good evening âœ¨ Letâ€™s close the day with thoughtful communication and calm focus. ðŸŒ¿",
  "Dear Members, good evening ðŸŒŒ A short reflection strengthens tomorrowâ€™s clarity. What improved your day today? âœ”ï¸",
  "Dear Members, good evening ðŸŒ™ Stay relaxed and composed. A light evening rhythm supports better decisions tomorrow. ðŸŒ¿",
  "Dear Members, good evening âœ¨ Letâ€™s wind down respectfully and maintain the tone of our community. ðŸ¤",
  "Dear Members, good evening ðŸŒŒ If something remains unresolved, note it down for tomorrow. Free your mind tonight. ðŸ•Šï¸",
  "Dear Members, good evening ðŸŒ™ A calming routine tonight supports a productive morning. Move slowly and purposefully. âœ¨",
  "Dear Members, good evening âœ¨ Letâ€™s appreciate the small wins of today. Progress compounds quietly. ðŸŒ¿",
  "Dear Members, good evening ðŸŒŒ Keep the night peaceful. A settled mind creates stronger clarity tomorrow. âœ”ï¸",
  "Dear Members, good evening ðŸŒ™ Share a learning or insight if it may help someone. Collective progress matters. ðŸ¤",
  "Dear Members, good evening âœ¨ End the day with gentle reflection. Peace supports performance. ðŸŒ¿",
  "Dear Members, good evening ðŸŒŒ Letâ€™s stay mindful and prepare for tomorrow with balance and clarity. âœ”ï¸",
  "Dear Members, good evening ðŸŒ™ Set aside work calmly and allow yourself to unwind. A good close is as important as a good start. âœ¨",
  "Dear Members, good evening âœ¨ Slow the pace and breathe. Consistent calm builds stronger outcomes. ðŸŒ¿",
  "Dear Members, good evening ðŸŒŒ A peaceful night strengthens tomorrowâ€™s discipline. Stay gentle and focused. âœ”ï¸",
  "Dear Members, good evening ðŸŒ™ End the day with gratitude and intention. It shapes your next steps. âœ¨",
  "Dear Members, good evening âœ¨ Letâ€™s maintain respectful communication through the evening. Good culture is built daily. ðŸ¤",
  "Dear Members, good evening ðŸŒŒ A thoughtful close reduces stress. Keep the night organised and calm. âœ”ï¸",
  "Dear Members, good evening ðŸŒ™ Progress grows through balance. Rest well and start fresh tomorrow. ðŸŒ¿",
  "Dear Members, good evening âœ¨ Wishing you a calm and reflective evening. Gentle resets create strong days. ðŸŒ™",
  "Dear Members, good evening ðŸŒŒ Letâ€™s close the day lightly. Clarity comes from quiet moments. âœ”ï¸"
];

///////////////////////////////////////////////////////////////
// === PART 1: DATE / TIME HELPERS (ROBUST IST CONVERSION)
///////////////////////////////////////////////////////////////

function getISTDate() {
  // Robust conversion: get UTC time, then add IST offset (+5:30)
  const now = new Date();
  const utcMillis = now.getTime() + now.getTimezoneOffset() * 60000;
  const istOffsetMinutes = 330; // +5:30
  return new Date(utcMillis + istOffsetMinutes * 60000);
}

function formatMMDD(date) {
  const m = String(date.getMonth() + 1).padStart(2, "0");
  const d = String(date.getDate()).padStart(2, "0");
  return `${m}-${d}`;
}

function isLastDayOfMonth(date) {
  const test = new Date(date.getFullYear(), date.getMonth() + 1, 0);
  return date.getDate() === test.getDate();
}

// ISO week helper (for 4-week rotation)
function getISOWeek(date) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  return Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
}

///////////////////////////////////////////////////////////////
// === PART 2: SLOT NORMALIZATION + RESOLUTION (OVERRIDES)
///////////////////////////////////////////////////////////////

function normalizeSlot(slot) {
  if (slot === "morning") return "morning";
  if (slot === "noon") return "noon";
  if (slot === "afternoon") return "afternoon";
  return "evening";
}

function getSpecialDayMessage(date, slot) {
  const mmdd = formatMMDD(date);
  const dayOfMonth = date.getDate();

  // 1) Full-day overrides
  if (SPECIAL_FULL_DAY[mmdd]) {
    const block = SPECIAL_FULL_DAY[mmdd];
    if (slot === "morning" && block.morning) return block.morning;
    if (slot === "noon" && block.noon) return block.noon;
    if (slot === "afternoon" && block.afternoon) return block.afternoon;
    if (slot === "evening" && block.evening) return block.evening;
    if (slot === "midnight" && block.midnight) return block.midnight;
  }

  // 2) FY / single-slot overrides
  if (SPECIAL_SINGLE_SLOT[mmdd]) {
    const sd = SPECIAL_SINGLE_SLOT[mmdd];
    if (sd.slot === slot) return sd.message;
  }

  // 3) Month-End override (noon)
  if (isLastDayOfMonth(date) && slot === "noon") {
    return "Dear Members, good afternoon â³ Month-end is here â€” a good time to close loose ends, clear backlogs and step into the new month with readiness. Let's finish strong. âœ”ï¸";
  }

  // 4) Month-Start override (1st each month â†’ noon)
  if (dayOfMonth === 1 && slot === "noon") {
    return "Dear Members, good afternoon ðŸŒŸ A new month begins. Letâ€™s restart with clear goals, fresh energy and steady discipline. Wishing you a focused month ahead. ðŸ“˜";
  }

  // 5) Observance Days
  if (OBSERVANCE_DAYS[mmdd]) {
    const ob = OBSERVANCE_DAYS[mmdd];
    if (ob.slot === slot) return ob.message;
  }

  return null;
}

function getDayOfWeekMessage(date, slot) {
  const day = date.getDay();      // 0 = Sunday ... 6 = Saturday
  const weekIndex = getISOWeek(date) % 4; // rotates 0â€“3 weekly

  // Sunday
  if (day === 0) {
    if (slot === "noon") return SUNDAY_NOON[weekIndex];
    if (slot === "evening") return SUNDAY_EVENING[weekIndex];
    return null; // Sunday has only noon + evening
  }

  // Monday
  if (day === 1) {
    if (slot === "morning") return MONDAY_MORNING[weekIndex];
    if (slot === "noon") return MONDAY_NOON[weekIndex];
  }

  // Thursday (4) -> meetup idea
  if (day === 4 && slot === "noon") {
    return THURSDAY_MEETUP[weekIndex];
  }

  // Friday (5) -> refine meetup
  if (day === 5 && slot === "noon") {
    return FRIDAY_MEETUP[weekIndex];
  }

  // Saturday (6)
  if (day === 6) {
    if (slot === "morning") return SATURDAY_CONFIRM[weekIndex];
    if (slot === "afternoon") return SATURDAY_4PM[weekIndex];
    if (slot === "evening") return SATURDAY_8PM[weekIndex];
  }

  return null;
}

function getDefaultSlotMessage(slot) {
  if (slot === "morning") {
    return DEFAULT_MORNING[Math.floor(Math.random() * DEFAULT_MORNING.length)];
  }
  if (slot === "noon") {
    return DEFAULT_NOON[Math.floor(Math.random() * DEFAULT_NOON.length)];
  }
  if (slot === "afternoon") {
    return DEFAULT_AFTERNOON[Math.floor(Math.random() * DEFAULT_AFTERNOON.length)];
  }
  return DEFAULT_EVENING[Math.floor(Math.random() * DEFAULT_EVENING.length)];
}

function getMessageForSlot(slot, date = getISTDate()) {
  const normalized = normalizeSlot(slot);

  // 1) Special Day Override
  const special = getSpecialDayMessage(date, normalized);
  if (special) return special;

  // 2) Weekly Override (4-week rotation)
  const weekly = getDayOfWeekMessage(date, normalized);
  if (weekly) return weekly;

  // 3) Default slot pool
  return getDefaultSlotMessage(normalized);
}

///////////////////////////////////////////////////////////////
// === PART 3: TELEGRAM HELPERS (RETRY + LOGGING)
///////////////////////////////////////////////////////////////

const TELEGRAM_API_BASE = "https://api.telegram.org";

async function sendTelegramMessage(env, chatId, text, tries = 2) {
  const url = `${TELEGRAM_API_BASE}/bot${env.TELEGRAM_BOT_TOKEN}/sendMessage`;
  const payload = {
    chat_id: chatId,
    text,
    parse_mode: "HTML",
    disable_web_page_preview: true
  };

  for (let attempt = 1; attempt <= tries; attempt++) {
    try {
      const res = await fetch(url, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        console.log(`Telegram message sent (attempt ${attempt})`);
        return true;
      } else {
        const textResp = await res.text();
        console.warn(`Telegram sendMessage error (attempt ${attempt}):`, res.status, textResp);
      }
    } catch (err) {
      console.error(`Telegram sendMessage exception (attempt ${attempt}):`, err);
    }

    if (attempt < tries) {
      // small backoff
      await new Promise(r => setTimeout(r, 500 * attempt));
    }
  }

  console.error("Telegram sendMessage failed after retries.");
  return false;
}

///////////////////////////////////////////////////////////////
// === PART 4: CRON MAPPING + SCHEDULE HANDLING
///////////////////////////////////////////////////////////////

function cronToSlot(expr) {
  switch (expr) {
    case "30 2 * * *":  return "morning";   // 08:00 IST
    case "30 6 * * *":  return "noon";      // 12:00 IST
    case "30 10 * * *": return "afternoon"; // 16:00 IST
    case "30 14 * * *": return "evening";   // 20:00 IST
    default:
      console.warn("Unknown cron:", expr);
      return null;
  }
}

async function handleScheduled(event, env) {
  const slot = cronToSlot(event.cron);
  if (!slot) {
    console.warn("handleScheduled: unknown cron slot for", event.cron);
    return;
  }

  const date = getISTDate();

  // Sunday morning suppression: spec says no 8 AM on Sundays
  const day = date.getDay(); // 0 = Sunday
  if (day === 0 && slot === "morning") {
    console.log("Skipping morning message on Sunday as per policy.");
    return;
  }

  const message = getMessageForSlot(slot, date);

  if (!message || !message.trim()) {
    console.warn("No message resolved for slot:", slot);
    return;
  }

  const ok = await sendTelegramMessage(env, env.TELEGRAM_GROUP_ID, message);
  if (!ok) {
    // If you want to push alerts for failures, implement here (e.g., send to ops webhook)
    console.error("Scheduled broadcast failed for slot:", slot, "date:", date.toISOString());
  }
}

///////////////////////////////////////////////////////////////
// === PART 5: TELEGRAM WEBHOOK HANDLER (compat only)
///////////////////////////////////////////////////////////////

async function handleTelegramUpdate(env, update) {
  // This worker is only for broadcast scheduling.
  // We keep webhook endpoint for compatibility but intentionally ignore updates.
  return;
}

///////////////////////////////////////////////////////////////
// === PART 6: EXPORT (FETCH + SCHEDULED)
///////////////////////////////////////////////////////////////

export default {
  //-----------------------------------------------------------
  // HTTP FETCH HANDLER
  //-----------------------------------------------------------
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    // Health check
    if (request.method === "GET" && url.pathname === "/") {
      return new Response("KenFolios + VStreet Broadcast Worker is alive.", {
        status: 200,
        headers: { "content-type": "text/plain" }
      });
    }

    // Manual broadcast endpoint (simple; secured by hiding URL in Worker route or use a secret in headers)
    if (request.method === "POST" && url.pathname === "/test-broadcast") {
      let bodyText;
      try {
        const contentType = request.headers.get("content-type") || "";
        if (contentType.includes("application/json")) {
          const j = await request.json();
          bodyText = j.text || JSON.stringify(j);
        } else {
          bodyText = await request.text();
        }
      } catch (e) {
        bodyText = "Test message from KenFolios worker.";
      }
      const text = bodyText || "Test message from KenFolios worker.";

      // Fire-and-forget via waitUntil (keeps response snappy)
      ctx.waitUntil(sendTelegramMessage(env, env.TELEGRAM_GROUP_ID, text));

      return new Response(JSON.stringify({ ok: true }), {
        status: 200,
        headers: { "content-type": "application/json" }
      });
    }

    // Telegram webhook receiver (compat)
    if (request.method === "POST" && url.pathname === "/telegram/webhook") {
      const incomingSecret = request.headers.get("X-Telegram-Bot-Api-Secret-Token");

      if (incomingSecret !== env.TELEGRAM_WEBHOOK_SECRET) {
        console.warn("Unauthorized webhook attempt");
        return new Response("Unauthorized", { status: 401 });
      }

      let update;
      try {
        update = await request.json();
      } catch (e) {
        console.error("Invalid Telegram update format:", e);
        return new Response("Bad Request", { status: 400 });
      }

      // We intentionally ignore messages in this worker
      ctx.waitUntil(handleTelegramUpdate(env, update));
      return new Response("OK", { status: 200 });
    }

    return new Response("Not found", { status: 404 });
  },

  //-----------------------------------------------------------
  // CRON HANDLER â€” invoked by Cloudflare Cron Triggers
  //-----------------------------------------------------------
  async scheduled(event, env, ctx) {
    // event has 'cron' property matching the cron string
    ctx.waitUntil(handleScheduled(event, env));
  }
};
